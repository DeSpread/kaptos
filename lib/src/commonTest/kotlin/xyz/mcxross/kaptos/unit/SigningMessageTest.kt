package xyz.mcxross.kaptos.unit

import kotlin.test.Test
import kotlin.test.assertTrue
import xyz.mcxross.kaptos.Aptos
import xyz.mcxross.kaptos.account.Account
import xyz.mcxross.kaptos.core.crypto.Ed25519PrivateKey
import xyz.mcxross.kaptos.extension.toStructTag
import xyz.mcxross.kaptos.model.*
import xyz.mcxross.kaptos.transaction.builder.generateSigningMessageForTransaction
import xyz.mcxross.kaptos.util.runBlocking

const val TRANSFER_AMOUNT = 100UL

class SigningMessageTest {

  private val aptos = Aptos(AptosConfig(AptosSettings(network = Network.LOCAL)))

  private val alice =
    Account.fromPrivateKey(
      Ed25519PrivateKey("0xc5338cd251c22daa8c9c9cc94f498cc8a5c7e1d2e75287a5dda91096fe64efa5")
    )

  // Generates the proper message for transaction
  @Test
  fun testGenerateMessage() {
    println(alice.accountAddress.value)
    runBlocking {
      val txn =
        aptos.buildTransaction.simple(
          sender = alice.accountAddress,
          data =
            entryFunctionData {
              function = "0x1::coin::transfer"
              typeArguments = typeArguments {
                +TypeTagStruct(type = "0x1::aptos_coin::AptosCoin".toStructTag())
              }
              functionArguments = functionArguments {
                +MoveString(alice.accountAddress.value)
                +U64(TRANSFER_AMOUNT)
              }
            },
          options =
            InputGenerateTransactionOptions(accountSequenceNumber = 1, expireTimestamp = 100),
        )

      val message = generateSigningMessageForTransaction(txn)

      val list =
        listOf(
          181,
          233,
          125,
          176,
          127,
          160,
          189,
          14,
          85,
          152,
          170,
          54,
          67,
          169,
          188,
          111,
          102,
          147,
          189,
          220,
          26,
          159,
          236,
          158,
          103,
          74,
          70,
          30,
          170,
          0,
          177,
          147,
          151,
          140,
          33,
          57,
          144,
          196,
          131,
          61,
          247,
          21,
          72,
          223,
          124,
          228,
          157,
          84,
          199,
          89,
          214,
          182,
          217,
          50,
          222,
          34,
          178,
          77,
          86,
          6,
          11,
          122,
          242,
          170,
          1,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          2,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          1,
          4,
          99,
          111,
          105,
          110,
          8,
          116,
          114,
          97,
          110,
          115,
          102,
          101,
          114,
          1,
          7,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          1,
          10,
          97,
          112,
          116,
          111,
          115,
          95,
          99,
          111,
          105,
          110,
          9,
          65,
          112,
          116,
          111,
          115,
          67,
          111,
          105,
          110,
          0,
          2,
          32,
          151,
          140,
          33,
          57,
          144,
          196,
          131,
          61,
          247,
          21,
          72,
          223,
          124,
          228,
          157,
          84,
          199,
          89,
          214,
          182,
          217,
          50,
          222,
          34,
          178,
          77,
          86,
          6,
          11,
          122,
          242,
          170,
          8,
          100,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          64,
          13,
          3,
          0,
          0,
          0,
          0,
          0,
          100,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          100,
          0,
          0,
          0,
          0,
          0,
          0,
          0,
          4,
        )

      assertTrue { message.contentEquals(list.map { it.toByte() }.toByteArray()) }
    }
  }
}
